<!DOCTYPE html>
<!-- - add Bootstrap -->
<head>

</head>
<body>
  <!-- best practice for mobile web audio: have the user click a button to begin rather than attempt to autoplay sound -->
  <input type="button" id="enable_audio_button" value="Begin">

  <p id="loading_indicator" class="hidden">Loading...</p>

  <!-- slider ("range input") is disabled on page load -->
  <input id="crossfade_slider" type="range" min="0" max="1" step="0.01" disabled>

  <!-- Stop button is hidden on page load -->
  <input type="button" id="stop_button" value="Stop" class="hidden">

  <!-- audio engine! docs: https://tonejs.github.io -->
  <script src='./js/Tone.js'></script>

  <script src="./js/microevent.js"></script>
  
  <script type="module">
    import { WebAudioSession } from './js/web-audio-session.js'

    MicroEvent.mixin(WebAudioSession)

    WebAudioSession.bind('started', () => {
      // fires when audio session has started
    })

    WebAudioSession.bind('loaded', () => {
      // fires when all files are finished loading
      document.getElementById("loading_indicator").classList.add('hidden')
    })

    // to avoid weird uses of the word 'cue', let's say we have four episodes. each has the same ambient sound cue and each has a different, second sound cue

    // check the URL to see which episode we should be playing
    const queryParams = new URLSearchParams(document.location.search) // in the URL, this is everything after a question mark, i.e. "https://google.com/stuff?user=Bob" should return the object { user: "Bob" }

    let activeEpisode
    if(!queryParams || !queryParams.get('episode')){ 
      activeEpisode = 1 // in case of trouble, default to episode 1
    } else {
      activeEpisode = parseInt(queryParams.get('episode'))
    }

    console.log("Episode: " + activeEpisode)

    // define episodes and their audio files
    let episodes = [
      {
        episodeNumber: 1,
        episodeLabel: "Episode 1",
        audioAssets:[
          "./sounds/speck_-_It_Takes_Perspective_1.mp3",
          "./sounds/Wonderland_Window-Place.mp3"
        ]
      },{
        episodeNumber: 2,
        episodeLabel: "Episode 2",
        audioAssets:[
          "./sounds/speck_-_It_Takes_Perspective_1.mp3",
          "./sounds/Wonderland_Window-Place.mp3"
        ]
      },{
        episodeNumber: 3,
        episodeLabel: "Episode 3",
        audioAssets:[
          "./sounds/Reiswerk_-_Zona_Norte.mp3",
          "./sounds/Wonderland_Window-Place.mp3"
        ]
      },{
        episodeNumber: 4,
        episodeLabel: "Episode 4",
        audioAssets:[
          "./sounds/speck_-_It_Takes_Perspective_1.mp3",
          "./sounds/Wonderland_Window-Place.mp3"
        ]
      }
    ]
    
    // set up what happens when user interacts with slider
    document.getElementById("crossfade_slider").addEventListener('input', (event) => {
      // console.log(event)
      const value = event.target.value
      WebAudioSession.updateFaderValue(value)
    })

    // set up what happens when user interacts with Begin button
    document.getElementById("enable_audio_button").addEventListener('click', (event) => {
      
      document.getElementById("enable_audio_button").setAttribute('disabled', " ") // button will not accept further presses

      document.getElementById("loading_indicator").classList.remove('hidden')

      // get the audio assets for the active episode
      let activeAssets = episodes.find( episode => episode.episodeNumber == activeEpisode).audioAssets 

      WebAudioSession
        .enable(activeAssets) // pass the audio assets for this episode
        .then( () => {
          document.getElementById("crossfade_slider").removeAttribute('disabled') // enable the slider
          document.getElementById("enable_audio_button").remove() // delete the Begin button
          document.getElementById("stop_button").classList.remove('hidden') // show the Stop button
        })
        .catch(error => {
          // something went wrong, restore the button to a pressable state
          document.getElementById("enable_audio_button").removeAttribute('disabled')
          console.log(error)
        })
    })

    // set up the Stop button
    document.getElementById("stop_button").addEventListener( 'click', event => {
      WebAudioSession.stopAll()
    })

  </script>
</body>

<style>
  input {
    display: block;
    margin-top: 20px;
    margin-bottom: 20px;
  }

  .hidden {
    visibility: hidden;
  }
</style>
